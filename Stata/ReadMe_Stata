

 Outline of Stata code

TO PRODUCE THE RESULTS REPORTED IN TABLE 2 (time-fixed exposure)

Let Y represents the outcome, D the denominator for the outcome,  and A the intervention. Specifically, Y is the cumulative number of unauthorised absences up to the end of Year 4 and D the cumulative number of possible half sessions over the same period, while A is SEND provision in Year 1. 

We also denote H to be the first observation of the time varying (binary) variable hospitalization, i.e. it is hospitalization in Year 1. 
In our example there are also several baseline (binary) confounders, labelled in the data set as: "male", "white", "idacibin",  "eyfsp_bin".


1) G-computation 

There are different options available.

 1a. Option 1
 
 Fit a Poisson model and then use the "margins" command to derive the average potential outcomes.  A simple (incorrect) specification of the Y model would be:


.  poisson Y i.(male white idacibin  eyfsp_bin H) i.A, exp(D) 
.  margins A, post

The "margins" command produces predicted mean potential counts. We then need to translate them into rate ratios and rate differences using "nlcom" which provides approximate confidence intervals for these effects based on the delta method.

For the ATE expressed as a rate ratio, we type:


. nlcom _b[1.A]/ _b[0bn.A]

For the ATE expressed as a rate difference, we also need to provide the average denominator:

. su D
. scalar mean=r(mean)
. nlcom (_b[1.A])/mean- (_b[0bn.A])/mean           


To fit a more general outcome model that includes many interactions (such as the 3 version in Table 3) we write:

. #delimit; 
.  poisson Y i.(male white idacibin eyfsp_bin H)##i.A         
             i.(male white idacibin H)##i.eyfsp_bin##i.A      
             i.(male white idacibin)##i.H##i.A                
             i.(male white)##i.idacibin##i.A                     
             i.male##i.white##i.A, exp(D)
             ;
. #delimit cr              
. margins A, post


To produce the ATT similar step are followed- see "Simulation_Table2_github.do".


   1b. Option 2

  Alternatively we can write a dedicated "ado" program, the advantage being that one can better control the model specification. Standard errors (SEs) are then derived by bootstrap.

We have used a program called "SEND_gcomp.ado"  which we then run several times to bootstrap the SEs. When calling this program, one needs to specify the outcome Y, the exposure/intervention A, the denominator D and also H, the baseline value of the time varying confounder (we separated the time-varying confounder from the list of confounders to be able to use the same command to produce the results shown in Table 3):

. #delimit; 
   bootstrap    ATE_rate_ratio=r(ATE_rate_ratio)  ATT_rate_ratio=r(ATT_rate_ratio)
                ATE_rate_dif=r(ATE_rate_dif) ATT_rate_dif=r(ATT_rate_dif)
             , 
               reps(1000) nodrop seed(1212): 
               SEND_gcomp Y A D H;
. #delimit cr              

The output reports estimated ATE and ATT on both the rate ratio and rate difference scale.

The options "reps", "seeds" and "nodrop" are specific to the "bootstrap" command. 



2)  IPW 

In general, we could use the Stata commands called "teffects" to estima theATE and the ATT. Unfortunately the command does not support the setting with Poisson regression with denominators. We could  use instead our own command. First however we need to specify what variables to include in the PS model. For specification 1 in the table we can do this:

.  vl create base_conf=(male white idacibin eyfsp_bin)
.  #delimit; 
 	bootstrap    ATE_rr=r(ATE_rr)  ATE_rd=r(ATE_rd) 
        	     ATT_rr=r(ATT_rr)  ATT_rd=r(ATT_rd)  
              , 
              	    reps(1000) nodrop seed(1212): 
                    SEND_ipw Y A D H  
                 ;
#delimit cr         
     
The output reports estimated ATE and ATT on both the rate ratio and rate difference scale.


3) AIPW 

Fortunately the "teffects" command implements AIPW estimation for count data with denominator.  The syntax is as follows, for specification 1:

.  vl modify 	base_conf=(male white idacibin eyfsp_bin  H)

.  teffects aipw (rate $base_conf,poisson)   (A $base_conf)


This leads to estimate of potential outcomes, i.e. counts. To translate then into ATE on the rate ratio scale we use "nlcom" again.

.  nlcom ( _b[POmean:0.A]+_b[ATE:r1vs0.A])/_b[POmean:0.A]

For the rate  difference, we first find the mean denominator, then calculate the rates and then the rate difference:
.  su D
.  scalar mean=r(mean)
.  nlcom (_b[POmean:0.SEN1]+ _b[ATE:r1vs0.SEN1])/mean-(_b[POmean:0.SEN1])/mean


To estimate the ATT, we need to use the option {\tt atet} and then follow similar steps (see Simulations_Table2_github.do):
